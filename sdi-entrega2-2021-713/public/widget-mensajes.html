<div id="widget-mensajes">

    <!-- Comentarios -->
    <h2>Mensajes:</h2>

    <div class="form-group">
        <label class="control-label col-sm-2" for="agregar-mensaje">Mensaje:</label>
        <div class="col-sm-8">
            <input type="text" class="form-control" name="agregar-mensaje"
                   placeholder="Esriba aquÃ­ su mensaje" id="agregar-mensaje"/></div>
        <div class="col-sm-2">
            <button type="button" class="btn btn-primary" id="boton-agregar"
                    onclick="agregarMensaje()">
                <span class="glyphicon glyphicon-envelope"></span> Enviar
            </button>
        </div>
    </div>
    <br>
    <br>
    <div class="container-fluid" id="chat"></div>
    <br>
    <button onclick="widgetOfertas()" class="btn">Volver</button>
</div>

<script>
   $.ajax({
       url: URLbase + "/chat/" + idOfertaSeleccionada,
       type: "GET",
       data: {},
       dataType: 'json',
       headers: {"token": token},
       success: function (mensajes) {
           actualizarChat(mensajes);
       },
       error: function (error) {
           $("#contenedor-principal").load("widget-ofertas.html");
       }
   });

    function actualizarChat(mensajes){
        $("#chat").empty(); // Vaciar la tabla
        for (let i = 0; i < mensajes.length; i++) {
            let entregado = "   ðŸ—¸Entregado";
            let estilo = "text-secondary"
            if(mensajes[0].leido){
                entregado= "    ðŸ—¸ðŸ—¸LeÃ­do";
                estilo = "text-primary"
            }
            $("#chat").append(
                "<div class=\"panel panel-default\" id=" + mensajes[i]._id + ">" +
                    "<div class=\"panel-heading\">" +
                        "<div class=\"col-sm-10\"><b>" + mensajes[i].autor + "</b></div>"+
                        "<small>" + mensajes[i].fecha + "</small>"+ entregado +
                    "</div>"+
                    "<div class=\"panel-body\">" + mensajes[i].texto + "</div>" +
                "</div>");
        }
    }

    function agregarMensaje(){
        $.ajax({
            url: URLbase + "/mensaje/"+idOfertaSeleccionada,
            type: "POST",
            data: {
                texto: $("#agregar-mensaje").val()
            },
            dataType: 'json',
            headers: {"token": token},
            success: function (respuesta) {
                console.log(respuesta); // <-- Prueba
                $("#contenedor-principal").load("widget-mensajes.html");
            },
            error: function (error) {
                console.log(error); // <--Prueba
                $("#alertas").remove();
                let errores = error.responseJSON.errores;
                if (errores != null && errores.length > 0) {
                    $("#widget-mensajes").prepend("<div id = 'alertas' class='alert alert-danger'>" +
                        "<span class=\"glyphicon glyphicon-exclamation-sign\" aria-hidden=\"true\"></span>" +
                        "<ul id = 'ul-errores'></ul></div>");
                    for (let i = 0; i < errores.length; i++) {
                        $("#ul-errores").append("<li >" + errores[i] + "</li>");
                    }
                } else {
                    $("#widget-mensajes").prepend("<div id = 'alertas' class='alert alert-danger'>" +
                        "<span class=\"glyphicon glyphicon-exclamation-sign\" aria-hidden=\"true\"></span>" +
                        "Se ha producido un error no controlado</div>");
                }
            }
        });
    }
</script>